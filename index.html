<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ChatAI Bob</title>
<style>
  :root{
    --bg:#0b0f1a; --panel:#0b1220; --panel2:#111827; --border:#1f2937;
    --text:#e5e7eb; --muted:rgba(229,231,235,.75);
    --brand:#38bdf8; --danger:#fb7185; --ok:#34d399; --gold:gold;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial;background:var(--bg);color:var(--text)}
  .top{
    position:sticky;top:0;z-index:50;
    padding:12px;background:#020617;border-bottom:1px solid var(--border);
    display:flex;align-items:center;justify-content:space-between;gap:12px
  }
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .dot{width:8px;height:8px;border-radius:50%;background:#999;display:inline-block}
  .dot.ok{background:var(--ok)}
  .dot.bad{background:var(--danger)}
  .wrap{max-width:920px;margin:auto;padding:12px}
  .card{border:1px solid var(--border);background:var(--panel);border-radius:16px}
  #messages{
    height:calc(100vh - 210px);
    overflow-y:auto;
    padding:14px;
  }
  .msg{margin:10px 0;display:flex;gap:10px}
  .bubble{
    max-width:78%;
    padding:10px 12px;
    border-radius:14px;
    white-space:pre-wrap;word-break:break-word;
    border:1px solid var(--border);
    background:var(--panel2)
  }
  .msg.user{justify-content:flex-end}
  .msg.user .bubble{background:#38bdf822}
  .meta{font-size:12px;opacity:.75;margin-top:6px}
  .media{margin-top:10px}
  .media img{max-width:100%;border-radius:14px;border:1px solid var(--border)}
  .toolbar{
    padding:12px;border-top:1px solid var(--border);
    display:flex;flex-direction:column;gap:10px
  }
  textarea{
    width:100%;min-height:54px;max-height:180px;resize:vertical;
    padding:12px;border-radius:14px;border:1px solid var(--border);
    background:#0a1020;color:var(--text)
  }
  input,button{
    padding:10px 12px;border-radius:12px;border:1px solid var(--border);
    background:#0a1020;color:var(--text)
  }
  button{cursor:pointer;background:var(--brand);border:0;color:#001018;font-weight:bold}
  button.ghost{background:transparent;border:1px solid var(--brand);color:var(--text)}
  button.danger{background:var(--danger);color:#111827}
  .small{font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:7px 10px;border-radius:999px;
    background:var(--panel2);border:1px solid var(--border)
  }
  .rightBtn{
    background:var(--gold);color:#111827;border:0;font-weight:bold
  }
  .drawerMask{
    position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:80
  }
  .drawer{
    position:fixed;top:0;right:0;height:100%;width:min(420px,92vw);
    background:#020617;border-left:1px solid var(--border);
    padding:14px;display:none;z-index:90;overflow:auto
  }
  .drawer h3{margin:6px 0 10px 0}
  .sep{height:1px;background:var(--border);margin:12px 0}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .fileRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .fileRow input[type="file"]{flex:1;background:transparent;border:1px dashed var(--border)}
</style>
</head>

<body>
  <div class="top">
    <div class="row">
      <div style="font-weight:bold">ü§ñ ChatAI Bob</div>
      <span class="pill"><span class="dot" id="statusDot"></span><span id="statusText">Backend: controllo‚Ä¶</span></span>
      <span class="pill"><b>FREE</b><span class="small" id="planText">‚Äî</span></span>
    </div>

    <div class="row">
      <button class="rightBtn" id="openPremium">üíé Premium</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div id="messages"></div>

      <div class="toolbar">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <span class="pill"><span class="small">Client:</span><span id="clientIdLabel"></span></span>
            <span class="pill"><span class="small">Backend:</span><span id="netHint">‚Äî</span></span>
          </div>
          <div class="row">
            <button class="ghost" id="setBackendBtn" style="width:auto">‚öôÔ∏è Backend</button>
            <button class="danger" id="clearChatBtn" style="width:auto">üßπ Pulisci</button>
          </div>
        </div>

        <textarea id="input" placeholder="Scrivi‚Ä¶ (puoi chiedere anche immagini e video)"></textarea>

        <div class="actions">
          <button id="sendBtn" style="width:auto">Invia</button>
          <button class="ghost" id="imgBtn" style="width:auto">üñºÔ∏è Foto</button>
          <button class="ghost" id="vidBtn" style="width:auto">üéûÔ∏è Video</button>
          <button class="ghost" id="pdfBtn" style="width:auto">üìÑ PDF</button>
        </div>

        <div class="small">
          Suggerimento: usa i pulsanti. Oppure scrivi comandi:
          ‚Äú/foto il tuo prompt‚Äù, ‚Äú/video il tuo prompt‚Äù.
        </div>
      </div>
    </div>
  </div>

  <!-- Drawer Premium -->
  <div class="drawerMask" id="mask"></div>
  <div class="drawer" id="drawer">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">üíé Premium</h3>
      <button class="ghost" id="closePremium" style="width:auto">‚úñ</button>
    </div>

    <div class="sep"></div>

    <div class="card" style="padding:12px">
      <div class="small">Backend URL</div>
      <input id="apiBase" placeholder="https://chatai-bob-backend.onrender.com" />
      <button id="saveApi" style="width:100%">Salva e testa</button>
      <div class="small" id="backendDebug" style="margin-top:6px"></div>
    </div>

    <div class="sep"></div>

    <div class="card" style="padding:12px">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:bold">Accesso Premium</div>
          <div class="small">Login solo se hai Premium</div>
        </div>
        <button id="logoutBtn" class="danger" style="width:auto;display:none">Esci</button>
      </div>

      <div class="two" style="margin-top:10px">
        <input id="email" placeholder="Email" />
        <input id="password" type="password" placeholder="Password" />
      </div>

      <div class="two" style="margin-top:10px">
        <button id="signupBtn">Registrati</button>
        <button id="loginBtn">Login</button>
      </div>

      <div class="small" id="authStatus" style="margin-top:10px"></div>

      <div id="usageBox" class="card" style="padding:12px;margin-top:12px;display:none;background:#0b1220">
        <div style="font-weight:bold">üìä Utilizzo</div>
        <pre id="usageText" style="margin:8px 0 0 0;white-space:pre-wrap"></pre>
      </div>

      <div class="sep"></div>

      <div class="card" style="padding:12px;background:#0b1220">
        <div style="font-weight:bold;margin-bottom:6px">Pagamento</div>
        <a href="https://www.paypal.me/bobbob1979" target="_blank"
           style="display:block;background:gold;color:black;padding:10px;text-align:center;border-radius:12px;font-weight:bold;text-decoration:none">
          üí∞ Attiva Premium
        </a>
        <div class="small" style="margin-top:8px">
          Dopo pagamento: fai login (o chiedimi di aggiungere webhook in futuro).
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let API_BASE = localStorage.getItem("API_BASE") || "https://chatai-bob-backend.onrender.com";
  let TOKEN = localStorage.getItem("TOKEN") || "";

  const $ = (id) => document.getElementById(id);

  function getClientId(){
    let id = localStorage.getItem("client_id");
    if(!id){
      id = "client_" + crypto.randomUUID();
      localStorage.setItem("client_id", id);
    }
    return id;
  }

  function authHeaders(){
    return TOKEN ? { Authorization: "Bearer " + TOKEN } : {};
  }

  function setStatus(ok, text){
    $("statusDot").className = "dot " + (ok ? "ok" : "bad");
    $("statusText").textContent = text;
  }

  async function fetchWithTimeout(url, opts={}, timeoutMs=60000){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    try{
      return await fetch(url, { ...opts, signal: ctrl.signal });
    } finally {
      clearTimeout(t);
    }
  }

  async function safeJson(url, opts={}, timeoutMs=25000){
    try{
      const r = await fetchWithTimeout(url, opts, timeoutMs);
      const ct = (r.headers.get("content-type") || "").toLowerCase();
      if(ct.includes("application/json")) return await r.json();
      const t = await r.text();
      return { ok: r.ok, text: t };
    }catch(e){
      return { ok:false, error: e?.name === "AbortError" ? "Timeout" : "Connessione fallita" };
    }
  }

  async function checkHealth(){
    if(!API_BASE){
      setStatus(false, "Backend: inserisci URL");
      $("netHint").textContent = "‚Äî";
      return;
    }
    const d = await safeJson(API_BASE + "/health", { method:"GET" }, 12000);
    if(d && d.status === "ok"){
      setStatus(true, "Backend: online");
      $("netHint").textContent = "OK /health";
      $("backendDebug").textContent = "OK: /health";
      return true;
    }
    setStatus(false, "Backend: offline");
    $("netHint").textContent = d?.error || d?.text || "offline";
    $("backendDebug").textContent = "OFFLINE: " + (d?.error || d?.text || "offline");
    return false;
  }

  function addMessage(role, text){
    const wrap = document.createElement("div");
    wrap.className = "msg " + role;

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text || "";

    wrap.appendChild(bubble);
    $("messages").appendChild(wrap);
    $("messages").scrollTop = $("messages").scrollHeight;

    return { wrap, bubble };
  }

  function addMediaMessage(role, title, dataUrl, kind){
    const wrap = document.createElement("div");
    wrap.className = "msg " + role;

    const bubble = document.createElement("div");
    bubble.className = "bubble";

    const header = document.createElement("div");
    header.textContent = title;
    header.style.fontWeight = "bold";

    const media = document.createElement("div");
    media.className = "media";

    const img = document.createElement("img");
    img.src = dataUrl;
    img.alt = kind;

    media.appendChild(img);
    bubble.appendChild(header);
    bubble.appendChild(media);

    wrap.appendChild(bubble);
    $("messages").appendChild(wrap);
    $("messages").scrollTop = $("messages").scrollHeight;
  }

  function systemHello(){
    addMessage("ai", "Ciao üëã Sono ChatAI Bob.\nScrivi un messaggio o usa i pulsanti per Foto/Video/PDF.");
  }

  function clearChat(){
    $("messages").innerHTML = "";
    systemHello();
  }

  function normalizeReply(d){
    return d?.text || d?.detail || d?.error || d?.message || "Errore";
  }

  async function sendTextChat(userText){
    const text = (userText || "").trim();
    if(!text) return;

    // slash commands inside chat
    if(text.toLowerCase().startsWith("/foto ")){
      return await genImage(text.slice(6).trim());
    }
    if(text.toLowerCase().startsWith("/video ")){
      return await genVideo(text.slice(7).trim());
    }

    addMessage("user", text);
    $("input").value = "";

    const ai = addMessage("ai", "‚Ä¶");

    const body = {
      message: text,
      client_id: getClientId(),
      project_id: null,
      mic_used: false
    };

    const d = await safeJson(API_BASE + "/chat", {
      method:"POST",
      headers: { "Content-Type":"application/json", ...(TOKEN ? authHeaders() : {}) },
      body: JSON.stringify(body)
    }, 45000);

    ai.bubble.textContent = normalizeReply(d);
  }

  async function genImage(prompt){
    const p = (prompt || "").trim();
    if(!p){
      addMessage("ai", "‚ö†Ô∏è Scrivi un prompt per la foto.");
      return;
    }

    addMessage("user", "üñºÔ∏è Foto: " + p);
    const ai = addMessage("ai", "Genero foto‚Ä¶");

    const d = await safeJson(API_BASE + "/image", {
      method:"POST",
      headers: { "Content-Type":"application/json", ...(TOKEN ? authHeaders() : {}) },
      body: JSON.stringify({ prompt: p, client_id: getClientId() })
    }, 60000);

    if(d?.url){
      ai.wrap.remove();
      addMediaMessage("ai", "üñºÔ∏è Foto generata", d.url, "image");
    }else{
      ai.bubble.textContent = "‚ùå " + (d?.error || d?.detail || d?.text || "Errore");
    }
  }

  async function genVideo(prompt){
    const p = (prompt || "").trim();
    if(!p){
      addMessage("ai", "‚ö†Ô∏è Scrivi un prompt per il video/GIF.");
      return;
    }

    addMessage("user", "üéûÔ∏è Video: " + p);
    const ai = addMessage("ai", "Genero GIF‚Ä¶ (pu√≤ impiegare 30‚Äì90s)");

    const d = await safeJson(API_BASE + "/video", {
      method:"POST",
      headers: { "Content-Type":"application/json", ...(TOKEN ? authHeaders() : {}) },
      body: JSON.stringify({ prompt: p, client_id: getClientId() })
    }, 120000);

    if(d?.url){
      ai.wrap.remove();
      addMediaMessage("ai", "üéûÔ∏è GIF generata", d.url, "gif");
    }else{
      ai.bubble.textContent = "‚ùå " + (d?.error || d?.detail || d?.text || "Errore");
    }
  }

  async function analyzePdf(file, prompt){
    if(!file){
      addMessage("ai", "‚ö†Ô∏è Seleziona un PDF.");
      return;
    }
    const p = (prompt || "").trim();
    if(!p){
      addMessage("ai", "‚ö†Ô∏è Scrivi cosa vuoi fare sul PDF (es. riassumi, estrai dati‚Ä¶).");
      return;
    }

    addMessage("user", "üìÑ PDF: " + file.name + "\nRichiesta: " + p);
    const ai = addMessage("ai", "Analizzo PDF‚Ä¶");

    const fd = new FormData();
    fd.append("file", file);
    fd.append("prompt", p);
    fd.append("project_id", "");
    fd.append("client_id", getClientId());

    try{
      const r = await fetchWithTimeout(API_BASE + "/analyze", {
        method:"POST",
        headers: { ...(TOKEN ? authHeaders() : {}) },
        body: fd
      }, 120000);

      const ct = (r.headers.get("content-type") || "").toLowerCase();
      const d = ct.includes("application/json") ? await r.json() : { text: await r.text() };
      ai.bubble.textContent = normalizeReply(d);
    }catch(e){
      ai.bubble.textContent = "‚ùå " + (e?.name === "AbortError" ? "Timeout" : "Errore connessione");
    }
  }

  // ---- Premium Drawer ----
  function openDrawer(){
    $("mask").style.display = "block";
    $("drawer").style.display = "block";
  }
  function closeDrawer(){
    $("mask").style.display = "none";
    $("drawer").style.display = "none";
  }

  $("openPremium").onclick = openDrawer;
  $("closePremium").onclick = closeDrawer;
  $("mask").onclick = closeDrawer;

  $("setBackendBtn").onclick = openDrawer;

  $("saveApi").onclick = async () => {
    API_BASE = $("apiBase").value.trim().replace(/\/+$/, "");
    localStorage.setItem("API_BASE", API_BASE);
    await checkHealth();
  };

  $("signupBtn").onclick = async () => {
    const email = $("email").value.trim();
    const password = $("password").value;
    const d = await safeJson(API_BASE + "/auth/signup", {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ email, password })
    }, 25000);
    $("authStatus").textContent = d?.ok ? "‚úÖ Registrato. Ora fai login." : ("‚ùå " + (d?.error || d?.detail || "Errore"));
  };

  async function loadMe(){
    if(!TOKEN) return;
    const d = await safeJson(API_BASE + "/me", { headers: { ...authHeaders() } }, 25000);
    if(d?.ok){
      $("usageBox").style.display = "block";
      $("usageText").textContent = JSON.stringify(d, null, 2);
      $("logoutBtn").style.display = "inline-block";
      $("planText").textContent = "Premium attivo";
    }else{
      $("usageBox").style.display = "none";
      $("planText").textContent = "FREE";
    }
  }

  $("loginBtn").onclick = async () => {
    const email = $("email").value.trim();
    const password = $("password").value;
    const d = await safeJson(API_BASE + "/auth/login", {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ email, password })
    }, 25000);

    if(d?.ok && d?.token){
      TOKEN = d.token;
      localStorage.setItem("TOKEN", TOKEN);
      $("authStatus").textContent = "‚úÖ Login ok";
      $("logoutBtn").style.display = "inline-block";
      await loadMe();
    }else{
      $("authStatus").textContent = "‚ùå " + (d?.error || d?.detail || "Errore login");
    }
  };

  $("logoutBtn").onclick = async () => {
    TOKEN = "";
    localStorage.removeItem("TOKEN");
    $("authStatus").textContent = "Sei uscito.";
    $("usageBox").style.display = "none";
    $("logoutBtn").style.display = "none";
    $("planText").textContent = "FREE";
  };

  // ---- Actions ----
  $("sendBtn").onclick = () => sendTextChat($("input").value);
  $("input").addEventListener("keydown", (e) => {
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendTextChat($("input").value);
    }
  });

  $("imgBtn").onclick = async () => {
    const p = prompt("Prompt foto (es: 'un cane astronauta'):");
    if(p) await genImage(p);
  };

  $("vidBtn").onclick = async () => {
    const p = prompt("Prompt video/GIF (es: 'tramonto sul mare'):");
    if(p) await genVideo(p);
  };

  $("pdfBtn").onclick = async () => {
    // mini workflow: scegli file + prompt
    const p = prompt("Cosa vuoi fare sul PDF? (es: 'riassumi e trova date'):");
    if(!p) return;

    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/pdf";
    input.onchange = async () => {
      const f = input.files && input.files[0];
      if(f) await analyzePdf(f, p);
    };
    input.click();
  };

  $("clearChatBtn").onclick = clearChat;

  // ---- Boot ----
  $("clientIdLabel").textContent = getClientId();
  $("apiBase").value = API_BASE;
  clearChat();
  checkHealth();
  if(TOKEN){
    $("logoutBtn").style.display = "inline-block";
    loadMe();
  }else{
    $("planText").textContent = "FREE";
  }
});
</script>
</body>
</html>
