<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatAI Bob</title>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0b0f1a">

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#0b0f1a;
  color:#e5e7eb;
}
.top{
  position:sticky;
  top:0;
  z-index:10;
  background:#020617;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #1f2937;
}
.badge{
  padding:6px 10px;
  border-radius:999px;
  background:#111827;
  border:1px solid #1f2937;
  font-size:12px;
}
.wrap{max-width:900px;margin:auto;padding:12px}
.card{
  background:#0b1220;
  border:1px solid #1f2937;
  border-radius:16px;
  overflow:hidden;
}
#messages{
  height:calc(100vh - 230px);
  overflow:auto;
  padding:14px;
}
.msg{margin:10px 0;display:flex}
.msg.user{justify-content:flex-end}
.bubble{
  max-width:78%;
  padding:12px;
  border-radius:14px;
  background:#111827;
  border:1px solid #1f2937;
  white-space:pre-wrap;
}
.msg.user .bubble{background:#38bdf822}
.toolbar{
  padding:12px;
  border-top:1px solid #1f2937;
}
input[type="text"]{
  width:100%;
  min-height:46px;
  border-radius:14px;
  background:#0a1020;
  color:#fff;
  border:1px solid #1f2937;
  padding:10px;
  outline:none;
}
button{
  padding:10px 14px;
  border-radius:12px;
  border:0;
  font-weight:bold;
  cursor:pointer;
}
.send{background:#38bdf8;color:#001018}
.ghost{
  background:transparent;
  color:#fff;
  border:1px solid #38bdf8;
}
.small{font-size:12px;opacity:.8}
.paypal-btn{
  display:inline-block;
  margin-top:8px;
  padding:10px 14px;
  border-radius:12px;
  background:#0070ba;
  color:#fff;
  font-weight:bold;
}
.paypal-btn:hover{opacity:.9}
</style>
</head>

<body>

<div class="top">
  <b>ü§ñ ChatAI Bob</b>
  <span class="badge"><span id="status">Backend: controllo‚Ä¶</span></span>
</div>

<div class="wrap">
  <div class="card">
    <div id="messages"></div>

    <div class="toolbar">

      <!-- INPUT (come richiesto da te) -->
      <input id="input" type="text" placeholder="Scrivi una domanda..." />

      <!-- BOTTONI (come richiesto da te) -->
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="ghost" 
          onclick="startVoice()">üé§</button>
        <button class="send" onclick="sendMessage()">Invia</button>
        <button class="ghost" id="clear">Pulisci</button>
      </div>
<input type="file" id="photo" accept="image/*" style="margin-top:10px" />
  <button class="ghost" onclick="sendPhoto()">üì∏ Analizza foto</button>
      <div class="small" style="margin-top:10px">
        Supporta il progetto ‚ù§Ô∏è<br>
        <a class="paypal-btn" href="https://www.paypal.me/bobbob1979" target="_blank">
          Dona con PayPal
        </a>
      </div>

    </div>
  </div>
</div>

<script>
const API = "https://chatai-bob-backend.onrender.com";
const $ = id => document.getElementById(id);

const CLIENT_ID = (() => {
  let id = localStorage.getItem("CLIENT_ID");
  if(!id){
    id = "web_" + Math.random().toString(36).slice(2);
    localStorage.setItem("CLIENT_ID", id);
  }
  return id;
})();

async function checkBackend(){
  try{
    const r = await fetch(API + "/health", { cache:"no-store" });
    const d = await r.json();
    $("status").textContent = d.status === "ok" ? "Online" : "Offline";
  }catch{
    $("status").textContent = "Offline";
  }
}

function add(role, text){
  const d = document.createElement("div");
  d.className = "msg " + role;
  d.innerHTML = `<div class="bubble"></div>`;
  d.querySelector(".bubble").textContent = text || "";
  $("messages").appendChild(d);
  $("messages").scrollTop = 999999;
}

/* ‚úÖ QUESTA √à LA FUNZIONE CHE USA IL BOTTONE "Invia" */
async function sendMessage(){
  const text = $("input").value.trim();
  if(!text) return;

  $("input").value = "";
  add("user", text);

  const ai = document.createElement("div");
  ai.className = "msg ai";
  ai.innerHTML = `<div class="bubble">‚Ä¶</div>`;
  $("messages").appendChild(ai);
  $("messages").scrollTop = 999999;

  try{
    const r = await fetch(API + "/chat",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ message:text, client_id:CLIENT_ID })
    });
    const d = await r.json();
    ai.remove();
    add("ai", d.text || "Errore");
  }catch{
    ai.remove();
    add("ai","Servizio non disponibile");
  }
}

/* ‚úÖ ENTER per inviare */
$("input").addEventListener("keydown", (e) => {
  if(e.key === "Enter"){
    e.preventDefault();
    sendMessage();
  }
});

/* ‚úÖ PULISCI */
$("clear").onclick = () => {
  $("messages").innerHTML = "";
  add("ai","Ciao üëã Come posso aiutarti?");
};

checkBackend();
setInterval(checkBackend, 30000);
add("ai","Ciao üëã Sono ChatAI Bob. Scrivi pure.");
</script>

<script>
let recognition;

/* üé§ VOCE */
function startVoice() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("Il microfono non √® supportato su questo browser");
    return;
  }

  recognition = new webkitSpeechRecognition();
  recognition.lang = 'it-IT';
  recognition.interimResults = false;

  recognition.onresult = function(event) {
    const text = event.results[0][0].transcript;
    document.getElementById("input").value = text;
    sendMessage();
  };

  recognition.start();
}

/* üì∏ FOTO + OCR */
async function sendPhoto() {
  const fileInput = document.getElementById("photo");
  const file = fileInput.files[0];

  if (!file) {
    alert("Seleziona prima una foto");
    return;
  }

  add("user", "üì∏ Analizza questa foto");

  // messaggio temporaneo
  const ai = document.createElement("div");
  ai.className = "msg ai";
  ai.innerHTML = `<div class="bubble">Analisi in corso...</div>`;
  document.getElementById("messages").appendChild(ai);
  document.getElementById("messages").scrollTop = 999999;

  const form = new FormData();
  form.append("file", file);
  form.append("question", "");
  form.append("client_id", CLIENT_ID());

  try {
    const r = await fetch(API + "/ocr_photo", {
      method: "POST",
      body: form
    });

    const data = await r.json();
    ai.remove();

    add("assistant", data.text || "Nessun testo riconosciuto.");
  } catch (e) {
    ai.remove();
    add("assistant", "Errore durante l‚Äôanalisi della foto.");
  }

  fileInput.value = "";
}
     
</script>
</body>
</html>

  
