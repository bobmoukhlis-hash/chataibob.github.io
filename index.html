<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatAI Bob FREE</title>

<style>
body{margin:0;font-family:Arial;background:#0b0f1a;color:#e5e7eb}
.top{padding:12px;background:#020617;display:flex;justify-content:space-between}
.dot{width:8px;height:8px;border-radius:50%;background:#999;display:inline-block}
.dot.ok{background:#34d399}
.dot.bad{background:#fb7185}
.chat{padding:12px;max-width:720px;margin:auto}
.msg{margin:8px 0;padding:10px;border-radius:10px;white-space:pre-wrap}
.user{background:#38bdf822}
.ai{background:#111827}
textarea,input,button,select{width:100%;margin:6px 0;padding:10px}
button{background:#38bdf8;border:0;font-weight:bold;border-radius:8px}
textarea{min-height:70px}

.premium-box{
  border:2px solid gold;
  padding:14px;
  border-radius:12px;
  margin:12px 0;
  background:#111827;
}
.premium-btn{
  display:block;
  background:gold;
  color:black;
  padding:10px;
  text-align:center;
  border-radius:10px;
  font-weight:bold;
  text-decoration:none;
}
.small{font-size:12px;opacity:.8}

#messages{max-height:50vh;overflow-y:auto}
</style>
</head>

<body>

<div class="top">
  <div>ğŸ¤– ChatAI Bob FREE</div>
  <div>
    <span class="dot" id="statusDot"></span>
    <span id="statusText">Backend: controlloâ€¦</span>
  </div>
</div>

<div class="chat">

<div id="authBox" class="premium-box">
  <h3>ğŸ” Accesso</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="signupBtn">Registrati</button>
  <button id="loginBtn">Login</button>
  <p class="small" id="authStatus"></p>
</div>

<input id="apiBase" placeholder="https://chatai-bob-backend.onrender.com">
<button id="saveApi">Salva backend URL</button>

<input id="projectName" placeholder="Nome progetto">
<select id="projectType">
  <option value="BOOK">ğŸ“˜ Libro</option>
  <option value="COACH">ğŸ§  Coaching</option>
  <option value="CODER">ğŸ’» Codice</option>
  <option value="GENERAL">âœ¨ Generale</option>
</select>
<button id="createProject">Crea progetto</button>

<div class="premium-box">
  <h3>ğŸ’ Passa a Premium</h3>
  <p>Chat senza limiti, voce, video, immagini, PDF</p>
  <a href="https://www.paypal.me/bobbob1979" target="_blank" class="premium-btn">
    ğŸ’° Attiva Premium
  </a>
</div>

<div id="usageBox" class="premium-box" style="display:none">
  <h3>ğŸ“Š Utilizzo</h3>
  <pre id="usageText"></pre>
</div>

<div id="projectList"></div>

<div id="messages"></div>
<textarea id="input" placeholder="Scrivi..."></textarea>
<button id="sendBtn">Invia</button>

</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

let API_BASE=localStorage.getItem("API_BASE")||"";
let TOKEN=localStorage.getItem("TOKEN")||"";

const $=id=>document.getElementById(id);

function getClientId(){
  let id=localStorage.getItem("client_id");
  if(!id){
    id="client_"+crypto.randomUUID();
    localStorage.setItem("client_id",id);
  }
  return id;
}

async function safeFetch(url,opts={}){
  try{
    const r=await fetch(url,opts);
    return await r.json();
  }catch(e){
    return {ok:false,error:"Connessione fallita"};
  }
}

function addMessage(role,text){
  const div=document.createElement("div");
  div.className="msg "+role;
  div.textContent=text;
  $("messages").appendChild(div);
  $("messages").scrollTop=$("messages").scrollHeight;
}

async function checkHealth(){
  if(!API_BASE)return;
  const d=await safeFetch(API_BASE+"/health");
  if(d.status==="ok"){
    $("statusDot").className="dot ok";
    $("statusText").textContent="Backend: verificato";
  }else{
    $("statusDot").className="dot bad";
    $("statusText").textContent="Backend: offline";
  }
}

$("saveApi").onclick=()=>{
  API_BASE=$("apiBase").value.trim().replace(/\/+$/,"");
  localStorage.setItem("API_BASE",API_BASE);
  checkHealth();
  loadMe();
  loadProjects();
};

$("sendBtn").onclick=async()=>{
  const text=$("input").value.trim();
  if(!text)return;
  addMessage("user",text);
  $("input").value="";
  const d=await safeFetch(API_BASE+"/chat",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      ...(TOKEN&&{Authorization:"Bearer "+TOKEN})
    },
    body:JSON.stringify({message:text,client_id:getClientId()})
  });
  addMessage("ai",d.text||d.detail||"Errore");
};

$("loginBtn").onclick=async()=>{
  const d=await safeFetch(API_BASE+"/auth/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      email:$("email").value,
      password:$("password").value
    })
  });
  if(d.ok){
    TOKEN=d.token;
    localStorage.setItem("TOKEN",TOKEN);
    $("authStatus").textContent="Login riuscito";
    loadMe();
    loadProjects();
  }else $("authStatus").textContent=d.error||"Errore";
};

$("signupBtn").onclick=async()=>{
  const d=await safeFetch(API_BASE+"/auth/signup",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      email:$("email").value,
      password:$("password").value
    })
  });
  $("authStatus").textContent=d.ok?"Registrazione ok":"Errore";
};

async function loadMe(){
  if(!TOKEN)return;
  const d=await safeFetch(API_BASE+"/me",{
    headers:{Authorization:"Bearer "+TOKEN}
  });
  if(d.ok){
    $("authBox").style.display="none";
    $("usageBox").style.display="block";
    $("usageText").textContent=JSON.stringify(d.usage,null,2);
  }
}

async function loadProjects(){
  if(!TOKEN)return;
  const d=await safeFetch(API_BASE+"/projects/list",{
    headers:{Authorization:"Bearer "+TOKEN}
  });
  $("projectList").innerHTML="";
  if(!d.ok)return;
  d.projects.forEach(p=>{
    const b=document.createElement("button");
    b.textContent="ğŸ“‚ "+p.name;
    $("projectList").appendChild(b);
  });
}

$("createProject").onclick=async()=>{
  const d=await safeFetch(API_BASE+"/projects/create",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+TOKEN
    },
    body:JSON.stringify({
      name:$("projectName").value,
      type:$("projectType").value
    })
  });
  if(d.ok)loadProjects();
};

$("apiBase").value=API_BASE;
checkHealth();
loadMe();
});
</script>

</body>
</html>
