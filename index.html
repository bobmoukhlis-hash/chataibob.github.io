<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatAI Bob</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#0b1220">

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#0b0f1a;
  color:#e5e7eb;
}
.top{
  position:sticky;
  top:0;
  background:#020617;
  padding:12px;
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid #1f2937;
}
.badge{
  padding:6px 10px;
  border-radius:999px;
  background:#111827;
  border:1px solid #1f2937;
  font-size:12px;
}
.wrap{max-width:900px;margin:auto;padding:12px}
.card{
  background:#0b1220;
  border:1px solid #1f2937;
  border-radius:16px;
}
#messages{
  height:calc(100vh - 260px);
  overflow:auto;
  padding:14px;
}
.msg{margin:10px 0;display:flex}
.msg.user{justify-content:flex-end}
.bubble{
  max-width:78%;
  padding:12px;
  border-radius:14px;
  background:#111827;
  border:1px solid #1f2937;
  white-space:pre-wrap;
}
.msg.user .bubble{background:#38bdf822}
.toolbar{padding:12px;border-top:1px solid #1f2937}
input[type=text]{
  width:100%;
  border-radius:14px;
  background:#0a1020;
  color:#fff;
  border:1px solid #1f2937;
  padding:10px;
}
button{
  padding:10px 14px;
  border-radius:12px;
  border:0;
  font-weight:bold;
  cursor:pointer;
}
button:disabled{opacity:.5}
.send{background:#38bdf8;color:#001018}
.ghost{background:transparent;color:#fff;border:1px solid #38bdf8}
.row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.small{font-size:12px;opacity:.85}
.paypal-btn{
  display:inline-block;
  margin-top:8px;
  padding:10px 14px;
  border-radius:12px;
  background:#0070ba;
  color:#fff;
  text-decoration:none;
}
</style>
</head>

<body>

<div class="top">
  <b>ü§ñ ChatAI Bob</b>
  <span class="badge" id="status">Offline</span>
</div>

<div class="wrap">
<div class="card">

<div id="messages"></div>

<div class="toolbar">

<input id="input" type="text" placeholder="Scrivi una domanda...">

<div class="row">
  <button class="ghost" onclick="startMic()">üé§ Microfono</button>
  <button class="send" onclick="sendMessage()">Invia</button>
  <button class="ghost" onclick="clearChat()">Pulisci</button>
  <button class="ghost" onclick="toggleVoice()" id="voiceBtn">üîä Voce ON</button>
</div>

<!-- FOTO SOLO GALLERIA (STABILE SU ANDROID) -->
<input type="file" id="photo" accept="image/*" style="margin-top:10px">

<button class="ghost" id="photoBtn" onclick="sendPhoto()" disabled>
üì∏ Analizza foto
</button>

<div class="small">
Supporta il progetto ‚ù§Ô∏è<br>
<a class="paypal-btn" href="https://www.paypal.me/bobbob1979" target="_blank">
Dona con PayPal
</a>
</div>

</div>
</div>
</div>

<script>
const API = "https://chatai-bob-backend.onrender.com";
const $ = id => document.getElementById(id);

/* PULIZIA TESTO (NO ** NO LISTE ROTTE) */
function cleanText(t){
  if(!t) return "";
  return t
    .replace(/\*\*(.*?)\*\*/g,"$1")
    .replace(/\*(.*?)\*/g,"$1")
    .replace(/^\s*[-*]\s+/gm,"")
    .replace(/^\s{0,3}#{1,6}\s+/gm,"")
    .replace(/\n{3,}/g,"\n\n")
    .trim();
}

/* CLIENT ID */
const CLIENT_ID = localStorage.CLIENT_ID || (
  localStorage.CLIENT_ID = "web_" + Math.random().toString(36).slice(2)
);

/* VOCE */
let VOICE_ON = true;
function toggleVoice(){
  VOICE_ON = !VOICE_ON;
  $("voiceBtn").textContent = VOICE_ON ? "üîä Voce ON" : "üîá Voce OFF";
  speechSynthesis.cancel();
}
function speak(t){
  if(!VOICE_ON || !t) return;
  const u = new SpeechSynthesisUtterance(t);
  u.lang = "it-IT";
  speechSynthesis.speak(u);
}

/* UI */
function add(role,text){
  const d=document.createElement("div");
  d.className="msg "+role;
  d.innerHTML=`<div class="bubble"></div>`;
  d.querySelector(".bubble").textContent=text;
  $("messages").appendChild(d);
  $("messages").scrollTop=999999;
}

function clearChat(){
  $("messages").innerHTML="";
  add("ai","Ciao üëã Come posso aiutarti?");
}

/* CHAT */
async function sendMessage(){
  const t=$("input").value.trim();
  if(!t) return;
  $("input").value="";
  add("user",t);

  const r=await fetch(API+"/chat",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({message:t,client_id:CLIENT_ID})
  }).catch(()=>null);

  if(!r){ add("ai","Servizio non disponibile"); return; }

  const d=await r.json();
  const clean=cleanText(d.text||"Errore");
  add("ai",clean);
  speak(clean);
}

/* MICROFONO */
function startMic(){
  if(!window.webkitSpeechRecognition) return;
  const rec=new webkitSpeechRecognition();
  rec.lang="it-IT";
  rec.onresult=e=>{
    $("input").value=e.results[0][0].transcript;
    sendMessage();
  };
  rec.start();
}

/* FOTO */
$("photo").onchange=()=> $("photoBtn").disabled=!$("photo").files[0];

async function sendPhoto(){
  const f=$("photo").files[0];
  if(!f){ add("ai","Seleziona una foto"); return; }

  add("user","üì∏ Analizza foto");

  const fd=new FormData();
  fd.append("file",f);
  fd.append("client_id",CLIENT_ID);

  const r=await fetch(API+"/ocr_photo",{method:"POST",body:fd}).catch(()=>null);
  if(!r){ add("ai","OCR non disponibile"); return; }

  const d=await r.json();
  const clean=cleanText(d.text || "Nessun testo rilevato");
  add("ai",clean);
  speak(clean);

  $("photo").value="";
  $("photoBtn").disabled=true;
}

/* START */
add("ai","Ciao üëã Sono ChatAI Bob. Scrivi pure.");
fetch(API+"/health").then(r=>r.json()).then(d=>{
  $("status").textContent=d.status==="ok"?"Online":"Offline";
});
</script>

</body>
</html>
