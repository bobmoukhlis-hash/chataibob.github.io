<script>
  const GROQ_PROXY_URL = "https://shy-poetry-9c52.bouabidmoukhlis.workers.dev";

  function detectLang() {
    const l = (navigator.language || "en").toLowerCase();
    return l.split("-")[0];
  }

  function looksArabic(text) {
    return /[\u0600-\u06FF]/.test(text);
  }

  function looksDarija(text) {
    const words = ["Ø´Ù†Ùˆ","ÙˆØ§Ø´","Ø¨Ø²Ø§Ù","Ø¯Ø§Ø¨Ø§","ÙÙŠÙ†","Ø¹Ø§ÙØ§Ùƒ","Ù…Ø²ÙŠØ§Ù†","Ù‡Ø§Ø¯","Ø¯ÙŠØ§Ù„","Ø¨ØºÙŠØª"];
    return words.some(w => text.includes(w));
  }

  function systemInstruction(userText) {
    const langMode = document.getElementById("langMode").value;
    const arabic = looksArabic(userText);
    const darija = looksDarija(userText);

    if (langMode !== "auto") {
      return `Reply ONLY in this language: ${langMode}. Be clear and professional.`;
    }

    return `
You are ChatAI Bob PRO 2026 (ðŸ‡²ðŸ‡¦).
Rules:
- Reply in the SAME language as the user.
- If Arabic script â†’ reply in Arabic.
- If Moroccan Darija â†’ reply in Darija.
- If Modern Standard Arabic â†’ reply in Fusha.
- Be short, practical, professional.
Detected: ${darija ? "Darija" : arabic ? "Arabic" : detectLang()}
`.trim();
  }

  async function sendMessage() {
    const text = document.getElementById("userText").value;
    const output = document.getElementById("output");
    const file = document.getElementById("imageInput").files[0];

    if (!text && !file) {
      output.textContent = "âš ï¸ Scrivi un messaggio o carica una foto.";
      return;
    }

    output.textContent = "â³ Attendi...";

    let messages = [];

    if (file) {
      const base64 = await toBase64(file);
      messages = [{
        role: "user",
        content: [
          { type: "text", text: text || "Analizza questa immagine" },
          { type: "image_url", image_url: { url: base64 } }
        ]
      }];
    } else {
      messages = [
        { role: "system", content: systemInstruction(text) },
        { role: "user", content: text }
      ];
    }

    try {
      const res = await fetch(GROQ_PROXY_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: file ? "llama-3.2-11b-vision-preview" : "llama-3.3-70b-versatile",
          messages,
          max_tokens: 600
        })
      });

      const data = await res.json();
      output.textContent =
        data.text ||
        data.choices?.[0]?.message?.content ||
        JSON.stringify(data, null, 2);

    } catch (e) {
      output.textContent = "âŒ Errore: " + e.message;
    }
  }

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }
</script>
