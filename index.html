<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ChatAI Bob FREE</title>
<style>
  body{margin:0;font-family:Arial;background:#0b0f1a;color:#e5e7eb}
  .top{padding:12px;background:#020617;display:flex;justify-content:space-between;gap:12px}
  .dot{width:8px;height:8px;border-radius:50%;background:#999;display:inline-block}
  .dot.ok{background:#34d399}
  .dot.bad{background:#fb7185}
  .chat{padding:12px;max-width:820px;margin:auto}
  .box{border:1px solid #1f2937;padding:14px;border-radius:14px;margin:12px 0;background:#0b1220}
  textarea,input,button,select{width:100%;margin:6px 0;padding:10px;box-sizing:border-box}
  button{background:#38bdf8;border:0;font-weight:bold;border-radius:10px;cursor:pointer}
  #debug{font-size:12px;opacity:.8;white-space:pre-wrap}
</style>
</head>
<body>
  <div class="top">
    <div>ðŸ¤– ChatAI Bob FREE</div>
    <div>
      <span class="dot" id="statusDot"></span>
      <span id="statusText">Backend: controlloâ€¦</span>
    </div>
  </div>

  <div class="chat">
    <div class="box">
      <input id="apiBase" placeholder="https://chatai-bob-backend.onrender.com">
      <button id="saveApi">Salva backend URL</button>
      <div id="debug"></div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const $ = (id) => document.getElementById(id);

  let API_BASE = localStorage.getItem("API_BASE") || "";
  $("apiBase").value = API_BASE;

  function setStatus(ok, text){
    $("statusDot").className = ok ? "dot ok" : "dot bad";
    $("statusText").textContent = text;
  }

  function logDebug(msg){
    $("debug").textContent = msg;
  }

  async function fetchWithTimeout(url, opts={}, timeoutMs=6000){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    try{
      const r = await fetch(url, { ...opts, signal: ctrl.signal });
      return r;
    } finally {
      clearTimeout(t);
    }
  }

  async function tryHealthOnce(path){
    const url = API_BASE + path;
    const r = await fetchWithTimeout(url, { method:"GET" }, 6000);
    const ct = (r.headers.get("content-type") || "").toLowerCase();

    if(ct.includes("application/json")){
      const d = await r.json();
      // accetta vari formati
      if(d.status === "ok" || d.ok === true) return { ok:true, detail:`${path} -> JSON ok` };
      return { ok:false, detail:`${path} -> JSON ma non ok (${JSON.stringify(d).slice(0,120)})` };
    }

    // se non Ã¨ json, ma risponde 200, consideriamo "online"
    if(r.ok) return { ok:true, detail:`${path} -> HTTP ${r.status}` };

    return { ok:false, detail:`${path} -> HTTP ${r.status}` };
  }

  async function checkHealth(){
    if(!API_BASE){
      setStatus(false, "Backend: inserisci URL");
      return;
    }

    setStatus(false, "Backend: controlloâ€¦");

    try{
      // prova endpoints tipici (FastAPI: /health o /docs)
      const paths = ["/health", "/docs", "/"];
      let lastDetail = "";
      for(const p of paths){
        try{
          const res = await tryHealthOnce(p);
          lastDetail = res.detail;
          if(res.ok){
            setStatus(true, "Backend: online");
            logDebug("OK: " + lastDetail);
            return;
          }
        }catch(e){
          lastDetail = `${p} -> errore: ${e.name || e}`;
        }
      }
      setStatus(false, "Backend: offline");
      logDebug("OFFLINE: " + lastDetail + "\nPossibile CORS o endpoint /health mancante.");
    }catch(e){
      setStatus(false, "Backend: offline");
      logDebug("OFFLINE: errore generico: " + (e.name || e));
    }
  }

  $("saveApi").onclick = () => {
    API_BASE = $("apiBase").value.trim().replace(/\/+$/, "");
    localStorage.setItem("API_BASE", API_BASE);
    checkHealth();
  };

  checkHealth();
});
</script>
</body>
</html>
