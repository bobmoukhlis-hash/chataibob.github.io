<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatAI Bob</title>

<style>
body{
  margin:0;font-family:Arial;background:#0b0f1a;color:#e5e7eb
}
.top{
  position:sticky;top:0;z-index:10;
  padding:12px;background:#020617;
  display:flex;justify-content:space-between;align-items:center
}
.dot{width:8px;height:8px;border-radius:50%;background:#999;display:inline-block}
.dot.ok{background:#34d399}
.dot.bad{background:#fb7185}
.pill{
  padding:6px 10px;border-radius:999px;
  background:#111827;border:1px solid #1f2937;
  font-size:12px
}
.wrap{max-width:900px;margin:auto;padding:12px}
#messages{height:60vh;overflow:auto;padding:10px}
.msg{margin:10px 0}
.bubble{
  background:#111827;border:1px solid #1f2937;
  border-radius:14px;padding:10px;white-space:pre-wrap
}
.msg.user .bubble{background:#38bdf822}
textarea{
  width:100%;min-height:60px;
  background:#020617;color:#e5e7eb;
  border:1px solid #1f2937;border-radius:12px;padding:10px
}
button{
  background:#38bdf8;border:0;
  padding:10px 14px;border-radius:12px;
  font-weight:bold;cursor:pointer
}
button.ghost{
  background:transparent;border:1px solid #38bdf8;color:#e5e7eb
}
.media img{max-width:100%;border-radius:14px;margin-top:8px}
</style>
</head>

<body>

<div class="top">
  <div>ðŸ¤– ChatAI Bob</div>
  <div class="pill">
    <span class="dot" id="statusDot"></span>
    <span id="statusText">Backend: controlloâ€¦</span>
  </div>
</div>

<div class="wrap">
  <div id="messages"></div>

  <textarea id="input"
    placeholder="Scrivi normalmente: la chat capisce testo, foto o video/GIF."></textarea>

  <div style="margin-top:10px;display:flex;gap:8px">
    <button id="sendBtn">Invia</button>
    <button class="ghost" id="saveApi">Salva backend URL</button>
  </div>

  <input id="apiBase"
    style="margin-top:10px"
    placeholder="https://chatai-bob-backend.onrender.com">
</div>

<script>
const API_DEFAULT = "https://chatai-bob-backend.onrender.com";
let API_BASE = localStorage.getItem("API_BASE") || API_DEFAULT;

const $ = id => document.getElementById(id);

function addMessage(role,text){
  const d=document.createElement("div");
  d.className="msg "+role;
  const b=document.createElement("div");
  b.className="bubble";
  b.textContent=text;
  d.appendChild(b);
  $("messages").appendChild(d);
  $("messages").scrollTop=$("messages").scrollHeight;
  return b;
}

function addMedia(title,url){
  const d=document.createElement("div");
  d.className="msg ai";
  const b=document.createElement("div");
  b.className="bubble";
  b.innerHTML="<b>"+title+"</b><div class='media'><img src='"+url+"'></div>";
  d.appendChild(b);
  $("messages").appendChild(d);
  $("messages").scrollTop=$("messages").scrollHeight;
}

function setStatus(ok){
  $("statusDot").className="dot "+(ok?"ok":"bad");
  $("statusText").textContent=ok?"Backend: online":"Backend: offline";
}

async function checkHealth(){
  try{
    const r=await fetch(API_BASE+"/health");
    const d=await r.json();
    setStatus(d.status==="ok");
  }catch{
    setStatus(false);
  }
}

function stripCreateWords(t){
  return t.replace(/^(fammi|fai|crea|genera)\s+/i,"").trim();
}
// -------- AUTO INTENT (FINAL & SAFE) --------
function classifyIntent(text){
  const t = (text || "").toLowerCase().trim();

  // comandi espliciti
  if(t.startsWith("/foto "))
    return { kind:"image", prompt: stripCreateWords(text) };

  if(t.startsWith("/video "))
    return { kind:"video", prompt: stripCreateWords(text) };

  // verbi di creazione (OBBLIGATORI)
  const wantsCreate = /(fammi|fai|crea|genera|produci|realizza)/.test(t);

  const imageKW = [
    "foto","immagine","image","picture","disegno",
    "ritratto","poster","sfondo","wallpaper"
  ];

  const videoKW = [
    "video","gif","animazione","cartone","cartoon",
    "parla","parlante","muove","movimento"
  ];

  const hasImage = imageKW.some(k => t.includes(k));
  const hasVideo = videoKW.some(k => t.includes(k));

  // SOLO se lâ€™utente vuole CREARE
  if(wantsCreate && hasVideo)
    return { kind:"video", prompt: stripCreateWords(text) };

  if(wantsCreate && hasImage)
    return { kind:"image", prompt: stripCreateWords(text) };

  // TUTTO IL RESTO Ãˆ CHAT
  return { kind:"chat", prompt: text };
}
  const t = (text || "").toLowerCase().trim();

  // comandi espliciti
  if(t.startsWith("/foto "))
    return { kind:"image", prompt: stripCreateWords(text) };

  if(t.startsWith("/video "))
    return { kind:"video", prompt: stripCreateWords(text) };

  const wantsCreate = /(fammi|fai|crea|genera|produci|realizza)/.test(t);

  const imageKW = [
    "foto","immagine","image","picture","disegno",
    "ritratto","poster","sfondo","wallpaper"
  ];

  const videoKW = [
    "video","gif","animazione","cartoon","cartone",
    "parla","parlante","muove","movimento"
  ];

  const hasImage = imageKW.some(k => t.includes(k));
  const hasVideo = videoKW.some(k => t.includes(k));

  if(wantsCreate && hasVideo)
    return { kind:"video", prompt: stripCreateWords(text) };

  if(wantsCreate && hasImage)
    return { kind:"image", prompt: stripCreateWords(text) };

  // DEFAULT: CHAT
  return { kind:"chat", prompt: text };
}
  const t=text.toLowerCase();

  if(t.includes("video")||t.includes("gif")||t.includes("parla"))
    return {kind:"video",prompt:stripCreateWords(text)};

  if(t.includes("foto")||t.includes("immagine"))
    return {kind:"image",prompt:stripCreateWords(text)};

  if(t.split(" ").length<=6&&!t.endsWith("?"))
    return {kind:"image",prompt:text};

  return {kind:"chat",prompt:text};
}

function addDecisionBadge(kind){
  const label=kind==="image"?"ðŸ–¼ï¸ Riconosciuto: FOTO":
               kind==="video"?"ðŸŽžï¸ Riconosciuto: VIDEO/GIF":
               "ðŸ’¬ Riconosciuto: TESTO";
  addMessage("ai",label);
}

async function sendChat(text){
  addMessage("user",text);
  const ai=addMessage("ai","â€¦");
  const r=await fetch(API_BASE+"/chat",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({message:text,client_id:"web"})
  });
  const d=await r.json();
  ai.textContent=d.text||"Errore";
}

async function genImage(p){
  addMessage("user","ðŸ–¼ï¸ "+p);
  const ai=addMessage("ai","Genero fotoâ€¦");
  const r=await fetch(API_BASE+"/image",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({prompt:p})
  });
  const d=await r.json();
  ai.remove();
  if(d.url) addMedia("Foto generata",d.url);
}

async function genVideo(p){
  addMessage("user","ðŸŽžï¸ "+p);
  const ai=addMessage("ai","Genero GIFâ€¦");
  const r=await fetch(API_BASE+"/video",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({prompt:p})
  });
  const d=await r.json();
  ai.remove();
  if(d.url) addMedia("GIF generata",d.url);
}

async function autoSend(text){
  const d=classifyIntent(text);
  addDecisionBadge(d.kind);
  if(d.kind==="image") return genImage(d.prompt);
  if(d.kind==="video") return genVideo(d.prompt);
  return sendChat(text);
}

$("sendBtn").onclick=()=>{
  const t=$("input").value.trim();
  if(!t) return;
  $("input").value="";
  autoSend(t);
};

$("saveApi").onclick=()=>{
  API_BASE=$("apiBase").value.trim().replace(/\/+$/,"");
  localStorage.setItem("API_BASE",API_BASE);
  checkHealth();
};

$("apiBase").value=API_BASE;
addMessage("ai","Ciao ðŸ‘‹ Scrivi liberamente: testo, foto o video.");
checkHealth();
</script>

</body>
</html>
