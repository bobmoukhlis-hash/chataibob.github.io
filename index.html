<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ChatAI Bob PRO 2026</title>

<style>
  :root{
    --bg:#f4f6f8; --card:#ffffff; --text:#0b1220; --muted:#6b7280;
    --blue:#007bff; --blue2:#0a66ff; --border:#e5e7eb;
    --me:#e8f1ff; --ai:#f3f4f6; --danger:#ef4444;
    --shadow: 0 6px 18px rgba(0,0,0,.06);
  }
  [data-theme="dark"]{
    --bg:#0b0f17; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --blue:#2b7cff; --blue2:#4f8cff; --border:#1f2937;
    --me:#0b2a55; --ai:#1f2937; --danger:#f87171;
    --shadow: 0 10px 24px rgba(0,0,0,.35);
  }

  *{box-sizing:border-box}
  body{
    margin:0; padding:12px; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  }
  .wrap{max-width:760px;margin:0 auto}
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; padding:10px 12px; border-radius:14px;
    background:var(--card); box-shadow:var(--shadow); border:1px solid var(--border);
    position:sticky; top:8px; z-index:10;
  }
  .title{
    font-weight:800; letter-spacing:.2px; font-size:18px; display:flex; align-items:center; gap:8px;
  }
  .chip{
    font-size:12px; padding:4px 8px; border-radius:999px;
    border:1px solid var(--border); color:var(--muted); background:transparent;
  }
  .btn{
    border:none; border-radius:10px; padding:10px 12px;
    background:var(--blue); color:#fff; font-weight:700; cursor:pointer;
  }
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .btn2{
    border:1px solid var(--border); border-radius:10px; padding:10px 12px;
    background:var(--card); color:var(--text); font-weight:700; cursor:pointer;
  }
  .btnDanger{
    background:var(--danger); color:#fff; border:none;
  }
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .row > *{flex:1}
  .card{
    margin-top:12px; padding:12px; border-radius:14px; background:var(--card);
    border:1px solid var(--border); box-shadow:var(--shadow);
  }
  select, textarea, input{
    width:100%; font-size:16px; padding:10px 12px; border-radius:12px;
    border:1px solid var(--border); background:transparent; color:var(--text);
    outline:none;
  }
  textarea{min-height:88px; resize:vertical}
  .muted{color:var(--muted); font-size:13px}
  .hr{height:1px;background:var(--border);margin:12px 0}

  /* Chat */
  .chat{
    display:flex; flex-direction:column; gap:10px;
    max-height:52vh; overflow:auto; padding-right:4px;
  }
  .bubble{
    max-width:92%;
    padding:10px 12px; border-radius:14px;
    border:1px solid var(--border);
    white-space:pre-wrap; line-height:1.35;
  }
  .me{align-self:flex-end; background:var(--me)}
  .ai{align-self:flex-start; background:var(--ai)}
  .meta{font-size:12px;color:var(--muted);margin-top:6px}
  .status{
    margin-top:8px; padding:10px 12px; border-radius:12px;
    border:1px dashed var(--border); color:var(--muted); background:transparent;
    white-space:pre-wrap;
  }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px; border-radius:12px; border:1px solid var(--border);
    background:transparent; color:var(--text); font-weight:700; cursor:pointer;
  }
  .pill[aria-pressed="true"]{border-color:var(--blue2)}
  .small{font-size:12px; padding:8px 10px}
  .footer{opacity:.65; text-align:center; padding:16px 0; font-size:13px}
  .imgPrev{max-width:100%; border-radius:12px; border:1px solid var(--border); margin-top:10px}
</style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="title">ğŸ‡²ğŸ‡¦ ChatAI Bob PRO 2026 <span class="chip">Global</span></div>
    <div class="row" style="justify-content:flex-end; flex:0; gap:8px">
      <button class="btn2 small" id="themeBtn">ğŸŒ™ Dark</button>
      <button class="btn2 small" id="copyBtn">ğŸ“‹ Copia</button>
      <button class="btn2 small btnDanger" id="clearBtn">ğŸ§¹ Reset</button>
    </div>
  </div>

  <!-- VISION -->
  <div class="card">
    <div class="row">
      <input type="file" id="imgInput" accept="image/*" />
      <button class="btn" id="imgBtn">ğŸ–¼ï¸ Analizza foto</button>
    </div>
    <img id="imgPreview" class="imgPrev" style="display:none" />
    <div id="imgResult" class="status">ğŸ“· Nessuna immagine analizzata.</div>
  </div>

  <!-- CONTROLS -->
  <div class="card">
    <div class="row">
      <select id="langMode">
        <option value="auto" selected>ğŸŒ AUTO (consigliato)</option>
        <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
        <option value="ar">ğŸ‡¸ğŸ‡¦ Arabic</option>
        <option value="ary">ğŸ‡²ğŸ‡¦ Darija</option>
      </select>

      <select id="modelMode">
        <option value="llama-3.3-70b-versatile" selected>âš¡ Chat: Llama 3.3 70B</option>
        <option value="llama-3.2-90b-vision-preview">ğŸ‘ï¸ Vision: Llama 3.2 90B</option>
      </select>
    </div>

    <div class="row">
      <button class="pill" id="micBtn" aria-pressed="false">ğŸ¤ Microfono</button>
      <button class="pill" id="ttsBtn" aria-pressed="false">ğŸ”Š Voce</button>
      <button class="pill" id="stopVoiceBtn">â›” Stop voce</button>
    </div>

    <div class="muted" id="hint">
      Microfono: funziona su Chrome/Android (se supportato). Voce: legge le risposte con TTS.
    </div>
  </div>

  <!-- CHAT -->
  <div class="card">
    <div class="chat" id="chat"></div>

    <div class="hr"></div>

    <textarea id="userText" placeholder="Scrivi come vuoiâ€¦ (Darija, Arabo, Italiano, ecc.)"></textarea>

    <div class="row">
      <button class="btn" id="sendBtn">ğŸš€ Invia</button>
      <button class="btn2" id="cancelBtn">ğŸ§¯ Annulla richiesta</button>
    </div>

    <div id="status" class="status">â³ Pronto.</div>
  </div>

  <div class="footer">Â© <span id="year"></span> ChatAI Bob PRO</div>
</div>

<script>
/* ============================
   CONFIG
============================ */
const GROQ_PROXY_URL = "https://groq-proxy-worker.bouabidmoukhlis.workers.dev";
document.getElementById("year").textContent = new Date().getFullYear();

/* ============================
   STATE
============================ */
let busy = false;
let abortCtrl = null;
let ttsEnabled = false;
let micEnabled = false;

/* ============================
   THEME
============================ */
const themeBtn = document.getElementById("themeBtn");
const savedTheme = localStorage.getItem("bob_theme") || "light";
setTheme(savedTheme);

function setTheme(mode){
  document.documentElement.setAttribute("data-theme", mode === "dark" ? "dark" : "light");
  localStorage.setItem("bob_theme", mode);
  themeBtn.textContent = (mode === "dark") ? "â˜€ï¸ Light" : "ğŸŒ™ Dark";
}

themeBtn.addEventListener("click", ()=>{
  const cur = localStorage.getItem("bob_theme") || "light";
  setTheme(cur === "dark" ? "light" : "dark");
});

/* ============================
   CHAT UI + STORAGE
============================ */
const chatEl = document.getElementById("chat");
const statusEl = document.getElementById("status");
const userText = document.getElementById("userText");

function loadChat(){
  const raw = localStorage.getItem("bob_chat");
  if(!raw) return;
  try{
    const arr = JSON.parse(raw);
    arr.forEach(m => addBubble(m.role, m.text, false));
    scrollChat();
  }catch{}
}
function saveChat(){
  const bubbles = [...chatEl.querySelectorAll(".bubble")].map(b=>({
    role: b.classList.contains("me") ? "user" : "assistant",
    text: b.querySelector(".content").textContent
  }));
  localStorage.setItem("bob_chat", JSON.stringify(bubbles));
}
function addBubble(role, text, persist=true){
  const wrap = document.createElement("div");
  wrap.className = "bubble " + (role === "user" ? "me" : "ai");

  const content = document.createElement("div");
  content.className = "content";
  content.textContent = text;

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = role === "user" ? "Tu" : "ChatAI Bob";

  wrap.appendChild(content);
  wrap.appendChild(meta);
  chatEl.appendChild(wrap);

  if(persist) saveChat();
  scrollChat();
}
function scrollChat(){
  chatEl.scrollTop = chatEl.scrollHeight;
}

loadChat();

/* ============================
   LANGUAGE DETECTION
============================ */
function looksArabic(t){ return /[\u0600-\u06FF]/.test(t); }
function looksDarija(t){
  return ["Ø´Ù†Ùˆ","ÙˆØ§Ø´","Ø¨Ø²Ø§Ù","Ø¯Ø§Ø¨Ø§","ÙÙŠÙ†","Ø¹Ø§ÙØ§Ùƒ","Ù…Ø²ÙŠØ§Ù†","Ù‡Ø§Ø¯","Ø¯ÙŠØ§Ù„","Ø¨ØºÙŠØª"].some(w=>t.includes(w));
}
function systemPrompt(t){
  const mode = document.getElementById("langMode").value;
  if(mode !== "auto") return `Reply ONLY in this language: ${mode}. Be short, clear, professional.`;

  if(looksDarija(t)) return "Reply in Moroccan Darija. Be concise and helpful.";
  if(looksArabic(t)) return "Reply in Arabic (ÙØµØ­Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ø³Ù…ÙŠ). Be concise and helpful.";
  return "Reply in the same language as the user. Be concise, useful, professional.";
}

/* ============================
   NETWORK (SAFE CALL)
============================ */
async function callGroq(payload, timeoutMs=25000){
  abortCtrl = new AbortController();
  const timer = setTimeout(()=>abortCtrl.abort("timeout"), timeoutMs);

  const r = await fetch(GROQ_PROXY_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload),
    signal: abortCtrl.signal
  }).catch(err=>{
    clearTimeout(timer);
    throw err;
  });

  clearTimeout(timer);

  const d = await r.json().catch(()=> ({}));
  return d?.choices?.[0]?.message?.content || d?.text || "";
}

/* ============================
   TTS
============================ */
const ttsBtn = document.getElementById("ttsBtn");
const stopVoiceBtn = document.getElementById("stopVoiceBtn");

ttsBtn.addEventListener("click", ()=>{
  ttsEnabled = !ttsEnabled;
  ttsBtn.setAttribute("aria-pressed", String(ttsEnabled));
  ttsBtn.textContent = ttsEnabled ? "ğŸ”Š Voce: ON" : "ğŸ”Š Voce: OFF";
  if(!ttsEnabled) window.speechSynthesis?.cancel();
});

stopVoiceBtn.addEventListener("click", ()=>{
  window.speechSynthesis?.cancel();
});

function speak(text){
  if(!ttsEnabled) return;
  if(!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text.slice(0, 1800));
  window.speechSynthesis.speak(u);
}

/* ============================
   MICROPHONE (SpeechRecognition)
============================ */
const micBtn = document.getElementById("micBtn");
let rec = null;

function initMic(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return null;
  const r = new SR();
  r.lang = "it-IT";
  r.interimResults = true;
  r.continuous = true;
  return r;
}

micBtn.addEventListener("click", ()=>{
  if(!rec) rec = initMic();
  if(!rec){
    statusEl.textContent = "âŒ Microfono non supportato su questo browser.";
    return;
  }

  micEnabled = !micEnabled;
  micBtn.setAttribute("aria-pressed", String(micEnabled));
  micBtn.textContent = micEnabled ? "ğŸ¤ Microfono: ON" : "ğŸ¤ Microfono: OFF";

  if(micEnabled){
    statusEl.textContent = "ğŸ¤ Sto ascoltandoâ€¦ parla ora.";
    let finalText = "";
    rec.onresult = (e)=>{
      let interim = "";
      for(let i=e.resultIndex;i<e.results.length;i++){
        const t = e.results[i][0].transcript;
        if(e.results[i].isFinal) finalText += t + " ";
        else interim += t;
      }
      userText.value = (finalText + interim).trim();
    };
    rec.onerror = ()=>{ statusEl.textContent = "âš ï¸ Errore microfono. Prova di nuovo."; };
    rec.onend = ()=>{
      if(micEnabled){
        // riparte automaticamente
        try{ rec.start(); }catch{}
      }
    };
    try{ rec.start(); }catch{}
  }else{
    try{ rec.stop(); }catch{}
    statusEl.textContent = "â³ Pronto.";
  }
});

/* ============================
   COPY / CLEAR
============================ */
document.getElementById("copyBtn").addEventListener("click", async ()=>{
  const lastAi = [...chatEl.querySelectorAll(".bubble.ai .content")].pop();
  const text = lastAi ? lastAi.textContent : "";
  if(!text){ statusEl.textContent = "âš ï¸ Nulla da copiare."; return; }
  try{
    await navigator.clipboard.writeText(text);
    statusEl.textContent = "âœ… Copiato negli appunti.";
  }catch{
    statusEl.textContent = "âš ï¸ Copia non riuscita (permessi browser).";
  }
});

document.getElementById("clearBtn").addEventListener("click", ()=>{
  if(busy) return;
  chatEl.innerHTML = "";
  localStorage.removeItem("bob_chat");
  statusEl.textContent = "ğŸ§¹ Chat pulita.";
});

/* ============================
   CANCEL REQUEST
============================ */
document.getElementById("cancelBtn").addEventListener("click", ()=>{
  if(abortCtrl){
    abortCtrl.abort("user_cancel");
    statusEl.textContent = "ğŸ§¯ Richiesta annullata.";
  }
});

/* ============================
   SEND MESSAGE
============================ */
const sendBtn = document.getElementById("sendBtn");

sendBtn.addEventListener("click", sendMessage);

async function sendMessage(){
  if(busy) return;

  const text = userText.value.trim();
  if(!text){ statusEl.textContent = "âš ï¸ Scrivi un messaggio."; return; }

  busy = true;
  sendBtn.disabled = true;

  addBubble("user", text);
  userText.value = "";
  statusEl.textContent = "â³ Attendiâ€¦";

  try{
    const model = "llama-3.3-70b-versatile";
    const reply = await callGroq({
      model,
      messages:[
        {role:"system", content: systemPrompt(text)},
        {role:"user", content: text}
      ],
      max_tokens: 650
    });

    if(!reply){
      addBubble("assistant", "âŒ Nessuna risposta. (Controlla Worker / chiave / rete)");
      statusEl.textContent = "âŒ Nessuna risposta.";
    }else{
      addBubble("assistant", reply);
      statusEl.textContent = "âœ… Fatto.";
      speak(reply);
    }
  }catch(e){
    const msg = (e?.name === "AbortError" || e === "timeout") ? "â±ï¸ Timeout / Annullato" : (e?.message || String(e));
    addBubble("assistant", "âŒ Errore: " + msg);
    statusEl.textContent = "âŒ Errore: " + msg;
  }

  busy = false;
  sendBtn.disabled = false;
}

/* ============================
   IMAGE ANALYSIS
============================ */
const imgBtn = document.getElementById("imgBtn");
const imgInput = document.getElementById("imgInput");
const imgPreview = document.getElementById("imgPreview");
const imgResult = document.getElementById("imgResult");

imgInput.addEventListener("change", ()=>{
  const f = imgInput.files?.[0];
  if(!f){ imgPreview.style.display="none"; return; }
  const url = URL.createObjectURL(f);
  imgPreview.src = url;
  imgPreview.style.display = "block";
});

imgBtn.addEventListener("click", analyzeImage);

async function toBase64(file){
  return await new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=>resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function analyzeImage(){
  if(busy) return;

  const file = imgInput.files?.[0];
  if(!file){ imgResult.textContent = "âŒ Nessun file selezionato."; return; }

  busy = true;
  imgBtn.disabled = true;
  imgResult.textContent = "â³ Analisi immagine...";

  try{
    const base64 = await toBase64(file);

    const reply = await callGroq({
      model: "llama-3.2-90b-vision-preview",
      messages: [{
        role:"user",
        content: [
          { type:"text", text:"Analizza questa immagine e descrivila in modo chiaro e utile." },
          { type:"image_url", image_url:{ url: base64 } }
        ]
      }],
      max_tokens: 320
    });

    imgResult.textContent = reply || "âŒ Nessuna risposta dall'analisi.";
    if(reply) speak(reply);
  }catch(e){
    const msg = (e?.name === "AbortError" || e === "timeout") ? "â±ï¸ Timeout / Annullato" : (e?.message || String(e));
    imgResult.textContent = "âŒ Errore analisi: " + msg;
  }

  busy = false;
  imgBtn.disabled = false;
}
</script>
</body>
</html>
