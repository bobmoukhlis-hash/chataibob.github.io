<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ChatAI Bob</title>

<style>
body{margin:0;font-family:Arial;background:#0b0f1a;color:#e5e7eb}
.top{position:sticky;top:0;z-index:10;background:#020617;padding:12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #1f2937}
.badge{padding:6px 10px;border-radius:999px;background:#111827;border:1px solid #1f2937;font-size:12px}
.wrap{max-width:900px;margin:auto;padding:12px}
.card{background:#0b1220;border:1px solid #1f2937;border-radius:16px;overflow:hidden}
#messages{height:calc(100vh - 240px);overflow:auto;padding:14px}
.msg{margin:10px 0;display:flex}
.msg.user{justify-content:flex-end}
.bubble{max-width:78%;padding:10px 12px;border-radius:14px;background:#111827;border:1px solid #1f2937;white-space:pre-wrap}
.msg.user .bubble{background:#38bdf822}
.media img{max-width:100%;border-radius:14px;margin-top:8px}
.toolbar{padding:12px;border-top:1px solid #1f2937}
textarea{width:100%;min-height:56px;border-radius:14px;background:#0a1020;color:#fff;border:1px solid #1f2937;padding:10px}
button{padding:10px 14px;border-radius:12px;border:0;font-weight:bold;cursor:pointer}
.send{background:#38bdf8;color:#001018}
.ghost{background:transparent;color:#fff;border:1px solid #38bdf8}
.gold{background:gold;color:#111}
.small{font-size:12px;opacity:.75}

/* Premium drawer */
.drawer{position:fixed;top:0;right:0;width:90vw;max-width:420px;height:100%;background:#020617;border-left:1px solid #1f2937;padding:14px;display:none;z-index:99}
.mask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:98}
</style>
</head>

<body>

<div class="top">
  <b>ü§ñ ChatAI Bob</b>
  <span class="badge"><span id="status">Backend: controllo‚Ä¶</span></span>
  <button class="gold" id="openPremium">üíé Premium</button>
</div>

<div class="wrap">
  <div class="card">
    <div id="messages"></div>
    <div class="toolbar">
      <textarea id="input" placeholder="Scrivi testo, foto o video/GIF"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="send" id="send">Invia</button>
        <button class="ghost" id="clear">Pulisci</button>
      </div>
      <div class="small" style="margin-top:6px">
        AUTO-MODE: ‚Äúcrea una foto‚Ä¶‚Äù, ‚Äúcrea un video‚Ä¶‚Äù
      </div>
    </div>
  </div>
</div>

<!-- PREMIUM -->
<div class="mask" id="mask"></div>
<div class="drawer" id="drawer">
  <h3>üíé Premium</h3>
  <button class="ghost" id="closePremium" style="margin-bottom:10px">Chiudi</button>

  <div class="small">Email</div>
  <input id="email" style="width:100%;padding:10px;border-radius:10px;border:1px solid #1f2937;background:#0a1020;color:#fff">

  <div class="small" style="margin-top:8px">Password</div>
  <input id="password" type="password" style="width:100%;padding:10px;border-radius:10px;border:1px solid #1f2937;background:#0a1020;color:#fff">

  <div style="display:flex;gap:6px;margin-top:10px">
    <button class="ghost" id="signup">Registrati</button>
    <button class="ghost" id="login">Login</button>
  </div>

  <div class="small" id="authStatus" style="margin-top:10px"></div>
</div>

<script>
/* ===== CONFIG ===== */
let API = localStorage.getItem("API") || "https://chatai-bob-backend.onrender.com";
let TOKEN = localStorage.getItem("TOKEN") || "";

/* ===== HELPERS ===== */
const $ = (id) => document.getElementById(id);

const CLIENT_ID = (() => {
  let id = localStorage.getItem("CLIENT_ID");
  if (!id) {
    id = "web_" + Math.random().toString(36).slice(2);
    localStorage.setItem("CLIENT_ID", id);
  }
  return id;
})();

/* ===== BACKEND STATUS ===== */
async function checkBackend(){
  try{
    const r = await fetch(API + "/health", { cache: "no-store" });
    const d = await r.json();
    $("status").textContent = (d.status === "ok") ? "Backend: online" : "Backend: offline";
  }catch{
    $("status").textContent = "Backend: offline";
  }
}

/* ===== UI ===== */
function add(role, text){
  const d = document.createElement("div");
  d.className = "msg " + role;
  d.innerHTML = `<div class="bubble"></div>`;
  d.querySelector(".bubble").textContent = text;
  $("messages").appendChild(d);
  $("messages").scrollTop = 999999;
  return d;
}

function addImg(title, url){
  if(!url){
    add("ai","‚ùå Errore generazione immagine/GIF");
    return;
  }
  const d = document.createElement("div");
  d.className = "msg ai";
  d.innerHTML = `
    <div class="bubble">
      <b>${title}</b>
      <div class="media">
        <img src="${url}" />
      </div>
    </div>`;
  $("messages").appendChild(d);
  $("messages").scrollTop = 999999;
}

/* ===== INTENT (UNA SOLA VOLTA) ===== */
function classifyIntent(t){
  t = t.toLowerCase().trim();

  // VIDEO solo se chiaramente richiesto
  if (/(^|\s)(video|gif|animazione|filmato)(\s|$)/.test(t)) return "video";

  // IMMAGINE
  if (/(^|\s)(foto|immagine|image|picture)(\s|$)/.test(t)) return "image";

  return "chat";
}

/* ===== SEND ===== */
async function send(){
  const text = $("input").value.trim();
  if(!text) return;

  $("input").value = "";
  add("user", text);

  const type = classifyIntent(text);
  const ai = add("ai", "‚Ä¶");

  const headers = {
    "Content-Type": "application/json",
    ...(TOKEN ? {"Authorization":"Bearer " + TOKEN} : {})
  };

  const payload =
    (type === "chat")
      ? { message: text, client_id: CLIENT_ID }
      : { prompt: text, client_id: CLIENT_ID };

  try{
    const r = await fetch(API + "/" + type, {
      method: "POST",
      headers,
      body: JSON.stringify(payload)
    });

    const d = await r.json();
    ai.remove();

    if(d.error){
      add("ai", "‚ùå " + d.error);
      return;
    }

    if(type === "chat"){
      add("ai", d.text || "Errore");
    }else if(type === "image"){
      addImg("üñº Foto", d.url);
    }else{
      addImg("üéû GIF", d.url);
    }
  }catch(e){
    ai.remove();
    add("ai","‚ùå Backend non raggiungibile");
  }
}

/* ===== PREMIUM DRAWER ===== */
function openDrawer(){
  $("drawer").style.display = "block";
  $("mask").style.display = "block";
}
function closeDrawer(){
  $("drawer").style.display = "none";
  $("mask").style.display = "none";
}
$("openPremium").onclick = openDrawer;
$("closePremium").onclick = closeDrawer;
$("mask").onclick = closeDrawer;

/* ===== AUTH ===== */
$("login").onclick = async () => {
  try{
    const r = await fetch(API + "/auth/login", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        email: $("email").value,
        password: $("password").value
      })
    });
    const d = await r.json();
    if(d.ok){
      localStorage.setItem("TOKEN", d.token);
      TOKEN = d.token;
      $("authStatus").textContent = "‚úÖ Login OK";
    }else{
      $("authStatus").textContent = "‚ùå Login fallito";
    }
  }catch{
    $("authStatus").textContent = "‚ùå Errore rete";
  }
};

$("signup").onclick = async () => {
  try{
    await fetch(API + "/auth/signup", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        email: $("email").value,
        password: $("password").value
      })
    });
    $("authStatus").textContent = "‚úÖ Registrato";
  }catch{
    $("authStatus").textContent = "‚ùå Errore rete";
  }
};

/* ===== EVENTS ===== */
$("send").onclick = send;
$("clear").onclick = () => {
  $("messages").innerHTML = "";
  add("ai","Ciao üëã");
};
$("input").onkeydown = (e) => {
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
};

/* ===== BOOT ===== */
checkBackend();
add("ai","Ciao üëã Scrivi testo, foto o video.");
</script>

</body>
</html>
