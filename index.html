<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatAI Bob FREE</title>

<style>
body{margin:0;font-family:Arial;background:#0b0f1a;color:#e5e7eb}
.top{padding:12px;background:#020617;display:flex;justify-content:space-between}
.dot{width:8px;height:8px;border-radius:50%;background:#999;display:inline-block}
.dot.ok{background:#34d399}
.dot.bad{background:#fb7185}
.chat{padding:12px}
.msg{margin:8px 0;padding:10px;border-radius:10px}
.user{background:#38bdf822}
.ai{background:#111827}
textarea,input,button,select{width:100%;margin:6px 0;padding:10px}
button{background:#38bdf8;border:0;font-weight:bold}
</style>
</head>

<body>

<div class="top">
  <div>ðŸ¤– ChatAI Bob FREE</div>
  <div>
    <span class="dot" id="statusDot"></span>
    <span id="statusText">Backend: non verificato</span>
  </div>
</div>

<div class="chat"><div class="premium-box">
  <h3>ðŸ’Ž Passa a Premium</h3>
  <p>Chat senza limiti, voce, video, immagini, PDF</p>

  <a href="https://www.paypal.me/bobbob1979"
     target="_blank"
     class="btn premium-btn">
     ðŸ’° Attiva Premium
  </a>

  <p class="small">
    Dopo il pagamento, Premium viene attivato subito.
  </p>
</div>
  <input id="apiBase" placeholder="https://chatai-bob-backend.onrender.com">
  <button id="saveApi">Salva backend URL</button>

  <!-- ðŸ“ PROGETTI -->
  <input id="projectName" placeholder="Nome progetto (es. Libro)">
  <select id="projectType">
    <option value="BOOK">ðŸ“˜ Libro</option>
    <option value="COACH">ðŸ§  Coaching</option>
    <option value="CODER">ðŸ’» Codice</option>
    <option value="GENERAL">âœ¨ Generale</option>
  </select>
  <button id="createProject">Crea progetto</button>
  <div id="projectList"></div>

  <div id="messages"></div>

  <textarea id="input" placeholder="Scrivi..."></textarea>
  <button id="sendBtn">Invia</button>
</div>

<script>
/* ================= CLIENT ID ================= */
function getClientId(){
  let id = localStorage.getItem("client_id");
  if(!id){
    id = "client_" + crypto.randomUUID();
    localStorage.setItem("client_id", id);
  }
  return id;
}

/* ================= BASE ================= */
let API_BASE = "";
const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");
const messages = document.getElementById("messages");
const input = document.getElementById("input");
const apiBaseInput = document.getElementById("apiBase");

/* ================= BACKEND ================= */
document.getElementById("saveApi").onclick = () => {
  API_BASE = apiBaseInput.value.trim().replace(/\/+$/, "");
  localStorage.setItem("API_BASE", API_BASE);
  checkHealth();
  loadProjects();
};

async function checkHealth(){
  if(!API_BASE) return;
  try{
    const r = await fetch(API_BASE + "/health");
    const d = await r.json();
    if(d.status==="ok"){
      statusDot.className="dot ok";
      statusText.textContent="Backend: online";
    } else throw "";
  }catch{
    statusDot.className="dot bad";
    statusText.textContent="Backend: offline";
  }
}

/* ================= CHAT ================= */
function addMessage(role,text){
  const div=document.createElement("div");
  div.className="msg "+role;
  div.textContent=text;
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
}

document.getElementById("sendBtn").onclick = async () => {
  const text=input.value.trim();
  if(!text)return;
  addMessage("user",text);
  input.value="";
  try{
    const r=await fetch(API_BASE+"/chat",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        message:text,
        client_id:getClientId()
      })
    });
    const d=await r.json();
    addMessage("ai",d.text||"Nessuna risposta");
  }catch{
    addMessage("ai","âŒ Errore connessione");
  }
};

/* ================= PROGETTI ================= */
async function loadProjects(){
  if(!API_BASE) return;
  const r = await fetch(API_BASE+"/projects/list?client_id="+getClientId());
  const d = await r.json();
  const list=document.getElementById("projectList");
  list.innerHTML="";
  d.projects.forEach(p=>{
    const b=document.createElement("button");
    b.textContent="ðŸ“‚ "+p.name+" ("+p.type+")";
    b.onclick=()=>selectProject(p.id,p.name);
    list.appendChild(b);
  });
}

async function selectProject(id,name){
  await fetch(API_BASE+"/projects/select",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      client_id:getClientId(),
      project_id:id
    })
  });
  alert("Progetto attivo: "+name);
}

document.getElementById("createProject").onclick = async ()=>{
  const name=document.getElementById("projectName").value.trim();
  const type=document.getElementById("projectType").value;
  if(!name) return alert("Inserisci nome");
  await fetch(API_BASE+"/projects/create",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      client_id:getClientId(),
      name,
      type
    })
  });
  document.getElementById("projectName").value="";
  loadProjects();
};

/* ================= INIT ================= */
(function(){
  const saved=localStorage.getItem("API_BASE");
  if(saved){
    API_BASE=saved;
    apiBaseInput.value=saved;
    checkHealth();
    loadProjects();
  }
})();
</script>

</body>
</html>
