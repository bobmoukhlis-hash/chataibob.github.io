<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ChatAI Bob</title>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0b0f1a">

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#0b0f1a;
  color:#e5e7eb;
}
.top{
  position:sticky; top:0; z-index:10;
  background:#020617;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #1f2937;
}
.badge{
  padding:6px 10px;
  border-radius:999px;
  background:#111827;
  border:1px solid #1f2937;
  font-size:12px;
}
.wrap{max-width:900px;margin:auto;padding:12px}
.card{
  background:#0b1220;
  border:1px solid #1f2937;
  border-radius:16px;
  overflow:hidden;
}
#messages{
  height:calc(100vh - 240px);
  overflow:auto;
  padding:14px;
}
.msg{margin:10px 0;display:flex}
.msg.user{justify-content:flex-end}
.bubble{
  max-width:78%;
  padding:10px 12px;
  border-radius:14px;
  background:#111827;
  border:1px solid #1f2937;
  white-space:pre-wrap;
  line-height:1.35;
}
.msg.user .bubble{background:#38bdf822}
.toolbar{padding:12px;border-top:1px solid #1f2937}
textarea{
  width:100%;
  min-height:60px;
  border-radius:14px;
  background:#0a1020;
  color:#fff;
  border:1px solid #1f2937;
  padding:10px;
  resize:none;
}
.row{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  margin-top:8px;
}
button{
  padding:10px 14px;
  border-radius:12px;
  border:0;
  font-weight:bold;
  cursor:pointer;
}
.send{background:#38bdf8;color:#001018}
.ghost{
  background:transparent;
  color:#fff;
  border:1px solid #38bdf8;
}
.small{font-size:12px;opacity:.75;margin-top:10px}
a{color:#38bdf8;text-decoration:none}

/* âœ… PayPal button */
.paypal-btn{
  display:inline-block;
  margin-top:8px;
  padding:10px 14px;
  border-radius:12px;
  background:#0070ba;
  color:#fff;
  font-weight:bold;
}
.paypal-btn:hover{ opacity:0.9; }
</style>
</head>

<body>

<div class="top">
  <b>ðŸ¤– ChatAI Bob</b>
  <span class="badge"><span id="status">Backend: controlloâ€¦</span></span>
</div>

<div class="wrap">
  <div class="card">
    <div id="messages"></div>

    <div class="toolbar">
      <textarea id="input" placeholder="Scrivi una domanda... (qualsiasi lingua)"></textarea>

      <div class="row">
        <button class="send" id="send">Invia</button>
        <button class="ghost" id="clear">Pulisci</button>
      </div>

      <div class="small">
        â˜• Se ti piace ChatAI Bob, puoi supportare il progetto:
        <br>
        <a class="paypal-btn" href="https://www.paypal.me/bobbob1979" target="_blank">ðŸ’™ Dona con PayPal</a>
      </div>
    </div>
  </div>
</div>

<script>
/* âœ… METTI QUI IL TUO BACKEND RENDER */
let API = localStorage.getItem("API") || "https://chatai-bob-backend.onrender.com";

const $ = (id) => document.getElementById(id);

const CLIENT_ID = (() => {
  let id = localStorage.getItem("CLIENT_ID");
  if(!id){
    id = "web_" + Math.random().toString(36).slice(2);
    localStorage.setItem("CLIENT_ID", id);
  }
  return id;
})();

function add(role, text){
  const d = document.createElement("div");
  d.className = "msg " + role;
  d.innerHTML = `<div class="bubble"></div>`;
  d.querySelector(".bubble").textContent = text || "";
  $("messages").appendChild(d);
  $("messages").scrollTop = 999999;
  return d;
}

async function checkBackend(){
  try{
    const r = await fetch(API + "/health", { cache:"no-store" });
    const d = await r.json();
    $("status").textContent = (d.status === "ok") ? "Backend: online" : "Backend: offline";
  }catch{
    $("status").textContent = "Backend: offline";
  }
}

async function postJson(path, body){
  const r = await fetch(API + path, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(body),
  });
  return await r.json();
}

async function send(){
  const text = $("input").value.trim();
  if(!text) return;

  $("input").value = "";
  add("user", text);

  const ai = add("ai", "â€¦");

  try{
    const d = await postJson("/chat", { message: text, client_id: CLIENT_ID });
    ai.remove();

    if(d.error) add("ai", "âŒ " + d.error);
    else add("ai", d.text || "âŒ Risposta vuota");
  }catch{
    ai.remove();
    add("ai", "âŒ Errore rete / backend non raggiungibile");
  }
}

/* eventi */
$("send").onclick = send;
$("clear").onclick = () => { $("messages").innerHTML = ""; };

$("input").addEventListener("keydown", (e) => {
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
});

/* âœ… avvio */
checkBackend();
setInterval(checkBackend, 30000);
add("ai", "Ciao ðŸ‘‹ Sono ChatAI Bob. Scrivimi in qualsiasi lingua!");
</script>

</body>
</html>
